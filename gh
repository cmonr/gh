#!/bin/bash -euf

set -o pipefail

readonly requested_action="${1}"
readonly requested_url="${2:-}"
readonly payload_file="${3:-}"

function die()
{
  echo "${1}" 1>&2
  exit 1
}

function urlencode()
{
  sed -e 's/ /%20/g' \
    -e 's/!/%21/g' \
    -e 's/#/%23/g' \
    -e 's/\$/%24/g' \
    -e "s/'/%27/g" \
    -e 's/(/%28/g' \
    -e 's/)/%29/g' <<< "${1}"
}


token=$(
  cat ~/.netrc \
    | tr '\n' ' ' \
    | tr -s ' ' \
    | rg "machine github.com" \
    | cut -d' ' -f6 \
    || die "Could not source GitHub token."
  )

action=${requested_action}
url=${requested_url}

case "${action}" in
  limits )
    action="get"
    url="/rate_limit"
    ;;
  get | delete )
    ;;
  post | patch )
    [[ -z "${payload_file}" ]] && die "No post data file provided."
    ;;
  *)
    die "Invalid action."
esac

[[ -z "${url}" ]] && die "No url provided."


curl --silent --include \
  --request $(echo "${action}" | tr '[:lower:]' '[:upper:]') \
  --header "Authorization: token ${token}" \
  --header "Content-Type: application/json" \
  --data @${payload_file} \
  --url $(urlencode "https://api.github.com${url}") 
